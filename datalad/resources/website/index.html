<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Datalad Repository</title>
        <link rel="shortcut icon" type="image/x-icon" href="https://datalad.org/pics/favicon-16x16.png" />
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
        <style type="text/css" class="init">
          body{
           max-width: 1200px;
           margin: 2em auto;
         }
         td.dir {font-weight: bold; color: #00A1CB; }
         td.git {font-weight: bold; color: #00BA88; }
         td.annex {font-weight: bold; color: #EC6C20; }
         td.link-broken {color:#E53B51; }
         td.link {color: #FFD03C;  }
         td.file {color: #67CDDC;  }
        </style>
    </head>
    <body>
        <h1><img src='http://datalad.org/pics/favicon.svg' width="24">Datalad Repository</h1>
        <table id="directory" class="display" width="100%" cellspacing="0"></table>
        <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-1.12.3.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.3.0/js/md5.min.js"></script>
        <script>
	 function directory() {
	     // construct path to metadata json based on directory to be rendered argument passed in url
	     var metadata_dir = '.git/datalad/metadata/'
	     var metadata_path = getParameterByName('dir') ? getParameterByName('dir').slice(1,-1) : '/';
	     var metadata_url = window.location.pathname + metadata_dir + md5(metadata_path);
	     var parent = false;

	     var table = $('#directory').DataTable( {
		 "async": true,    //async get json
		 "paging": false,  //ensure scrolling instead of pages
		 "ajax": {         //specify url to get json from ajax
		     "url": metadata_url,
		     "dataSrc": "nodes"
		 },
	         "order": [[ 6, "desc" ], [ 0, 'asc' ]],
		 "columns": [      //select columns and their names from json
                     { data: "name", title: "Name" },
                     { data: "date", title: "Last Modified", className: "dt-center", width: "20%" },
                     { data: "size", title: "Size", className: "dt-center" },
                     { data: null, title: "Description", className: "dt-center", render: function(data) { return '';}},
                     { data: "type", title: "Type", className: "dt-center" },
                     { data: "path", title: "Path", className: "dt-center" },
                     { data: null, title: "Sort", render: function(data) { return (data.type=='dir' || data.type=='git' || data.type=='annex');}}
	         ],
		 "createdRow": function ( row, data, index ) {
		     if (data.name == '..')
			 parent = true;
		     if (data.size.ondisk)
			 $('td', row).eq(2).html(data.size.ondisk + "/" + data.size.total);  // show size = "ondisk size" / "total size"
		     if (data.type == 'dir' || data.type == 'git' || data.type == 'annex')   // if row is a directory append '/' to name cell
			 $('td', row).eq(0).html('<a>'+$('td', row).eq(0).html()+'/'+'</a>');
		     if (data.name == '..')
			 $('td', row).eq(2).html('');
		     for(i = 0; i < 4; i++)                                                  // attach css based on node-type to visible columns of each row
			 $('td', row).eq(i).addClass(data.type);
		 },
		 // add click handlers to each row(cell) once table initialised
		 "initComplete": function () {
		     var api = this.api();
		     // all tables should have ../ parent path
		     if (!parent)
			 table.row.add({"name": "..", "repo": "", "date": "", "path": "", "type": "annex", "size": ""}).draw();
		     // add click handlers
		     api.$('tr').click( function () {           		                     // on clicking a row element
			 var data = table.row( this ).data();                                        // extract its data json from table
			 if (data.type == 'link-broken') { return; }                                 // don't do anything for broken links
			 var dir = getParameterByName('dir');                                        // get directory parameter
			 var move = data.name == '..' ? parent_url : child_url;                      // which direction to move, up or down the path ?
			 var next = dir ? move(dir, data.name) : move(absolute_url(''), data.name);  // which path to move, dir parameter or current path ?
			 update_param_or_path(next, data.type, dir) ? window.location.search = '?dir=' + next: window.location.assign(next);  // update parameter or url path with new path ?
		     });
		 }
	     });
	     table.columns([4,5,6]).visible(false);  // hide complete path, file type and sorting columns
	     return table;
	 }
	 // check if url exists
	 function url_exists(url) { var http = new XMLHttpRequest();  http.open('HEAD', url, false);  http.send();  return http.status!=404; }

	 // construct parent path of url passed
	 function parent_url(url, node_name) {  url_array = url.split(/[\\/]/);  url_array.splice(-2,1);  return url_array.join('/');  }

	 // construct child path of url passed
	 function child_url(url, node_name) {  return url + node_name;  }

	 // decompose url to actual path to node e.g if next_url=d1/d2/d3 and current_url = example.com/ds/?dir=d1/d2 -> return example.com/ds/d1/d2/d3
	 function absolute_url(next_url) {  return (window.location.pathname.replace(/\?.*/g, '') + next_url).replace('//','/');  }

	 //extract GET parameters from URL
	 function getParameterByName(name, url) {
	     // refer https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
	     if (!url) url = window.location.href;
	     name = name.replace(/[\[\]]/g, "\\$&");
	     var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		 results = regex.exec(url);
	     if (!results || !results[2]) return null;
	     return decodeURIComponent(results[2].replace(/\+/g, " "));
	 }

	 //to update parameter if url directory or not dataset
	 function update_param_or_path(url, type, current_state) {
	     // only check for index.html in directories of type annex, git,
	     // allows other dirs to have index.html, eases constrain on non-datalad index.html presence in dataset
	     if (type == 'git' || type == 'annex') {
		 url += '/index.html';
		 test_url = (current_state ? absolute_url(url): url).replace('//', '/');    // convert url to absolute if passed as parameter as its relative
		 return url_exists(test_url) ? false: true;                                 // if index.html exists @ url, the clicked node is a dataset
	     }
	     return type == 'dir' ? true: false
	 }
	 $(document).ready(function() {
	     var table = directory();   // construct table based on files in directory and their metadata
	 });
	</script>
    </body>
</html>
